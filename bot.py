import discord
from discord.ext import commands
import os
import re
import random
from dotenv import load_dotenv
from myserver import server_on

# ===== LOAD ENV =====
load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")

# ===== INTENTS =====
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ===== BAD WORDS =====
bad_words = [
    "à¸„à¸§à¸¢", "à¹€à¸«à¸µà¹‰à¸¢", "à¸ªà¸±à¸™à¸”à¸²à¸™", "à¸«à¸µ",
    "à¸«à¸£à¸£à¸¡", "à¸«à¸³", "à¹‚à¸‡à¹ˆ", "à¸à¸²à¸", "à¸à¸£à¸°à¸ˆà¸­à¸"
]

# ===== CLEAN TEXT =====
def clean_text(text: str) -> str:
    text = text.lower()
    text = re.sub(r"\s+", "", text) # à¸¥à¸šà¹€à¸§à¹‰à¸™à¸§à¸£à¸£à¸„
    text = re.sub(r"[^à¸-à¹™a-z0-9]", "", text) # à¹€à¸à¹‡à¸šà¹€à¸‰à¸žà¸²à¸° à¸-à¸®, a-z, 0-9
    return text

# =====================
# ðŸ§  SMART BRAIN (à¹€à¸­à¸²à¹€à¸™à¸·à¹‰à¸­à¹† à¹€à¸™à¹‰à¸™à¹† à¹„à¸¡à¹ˆà¹€à¸­à¸²à¸‚à¸¢à¸°)
# =====================
brain = []

# à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸³à¸•à¸­à¸šà¹ƒà¸«à¹‰à¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢à¸‚à¸¶à¹‰à¸™à¸•à¸£à¸‡à¸™à¸µà¹‰
topics = {
    "à¸—à¸±à¸à¸—à¸²à¸¢": ["à¸”à¸µà¸„à¸£à¸±à¸š", "à¸ªà¸§à¸±à¸ªà¸”à¸µ", "à¸«à¸§à¸±à¸”à¸”à¸µ", "hi", "hello", "à¸—à¸±à¸"],
    "à¸—à¸³à¹„à¸£": ["à¸—à¸³à¹„à¸£", "à¸—à¸³à¸­à¸°à¹„à¸£", "à¸—à¸³à¸­à¸¢à¸¹à¹ˆ", "à¸§à¹ˆà¸²à¸‡à¹„à¸«à¸¡", "à¸—à¸³à¹„à¸£à¸”à¸µ"],
    "à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸": ["à¹€à¸«à¸‡à¸²", "à¹€à¸šà¸·à¹ˆà¸­", "à¹€à¸„à¸£à¸µà¸¢à¸”", "à¸à¸¥à¸±à¸§", "à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢", "à¸—à¹‰à¸­", "à¸„à¸´à¸”à¸–à¸¶à¸‡"],
    "à¸„à¸³à¸–à¸²à¸¡": ["à¸—à¸³à¹„à¸¡", "à¸ˆà¸£à¸´à¸‡à¹„à¸«à¸¡", "à¹ƒà¸Šà¹ˆà¹„à¸«à¸¡", "à¸«à¸£à¸­", "?"],
    "à¸Šà¸µà¸§à¸´à¸•": ["à¸Šà¸µà¸§à¸´à¸•", "à¸­à¸™à¸²à¸„à¸•", "à¸„à¸§à¸²à¸¡à¸à¸±à¸™", "à¹‚à¸•à¸‚à¸¶à¹‰à¸™", "à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢"],
    "à¸•à¸¥à¸": ["555", "à¸•à¸¥à¸", "à¸‚à¸³"]
}

answers_pool = {
    "à¸—à¸±à¸à¸—à¸²à¸¢": ["à¸”à¸µà¸ˆà¹‰à¸²", "à¸«à¸§à¸±à¸”à¸”à¸µà¸§à¸±à¸¢à¸£à¸¸à¹ˆà¸™", "à¹„à¸‡ à¸¡à¸µà¹„à¸£à¹ƒà¸«à¹‰à¸Šà¹ˆà¸§à¸¢à¸›à¹ˆà¸²à¸§", "à¸®à¸²à¸¢à¸¢à¸¢"],
    "à¸—à¸³à¹„à¸£": ["à¸à¹‡à¸„à¸¸à¸¢à¸à¸±à¸šà¸„à¸¸à¸“à¹„à¸‡", "à¸™à¸±à¹ˆà¸‡à¸§à¹ˆà¸²à¸‡ à¹† à¸­à¸¢à¸¹à¹ˆ", "à¸„à¸´à¸”à¸­à¸°à¹„à¸£à¹„à¸›à¹€à¸£à¸·à¹ˆà¸­à¸¢", "à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¸£à¸±à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸­à¸¢à¸¹à¹ˆ"],
    "à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸": ["à¹‚à¸­à¹‹à¹† à¸™à¸°", "à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£à¸«à¸£à¸­à¸ à¹€à¸”à¸µà¹‹à¸¢à¸§à¸à¹‡à¸”à¸µà¸‚à¸¶à¹‰à¸™", "à¹€à¸£à¸²à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¸™à¸µà¹ˆà¸™à¸°", "à¸ªà¸¹à¹‰à¹† à¸™à¸°à¸„à¸™à¹€à¸à¹ˆà¸‡"],
    "à¸„à¸³à¸–à¸²à¸¡": ["à¸™à¸±à¹ˆà¸™à¸ªà¸´", "à¸à¹‡à¸™à¹ˆà¸²à¸„à¸´à¸”à¸™à¸°", "à¸­à¸²à¸ˆà¸ˆà¸°à¹ƒà¸Šà¹ˆà¸à¹‡à¹„à¸”à¹‰", "à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™"],
    "à¸Šà¸µà¸§à¸´à¸•": ["à¸Šà¸µà¸§à¸´à¸•à¸¡à¸±à¸™à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™à¸™à¸° à¸„à¹ˆà¸­à¸¢à¹† à¸„à¸´à¸”", "à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¸•à¸­à¸šà¹€à¸”à¸µà¸¢à¸§à¸«à¸£à¸­à¸", "à¸—à¸³à¸§à¸±à¸™à¸™à¸µà¹‰à¹ƒà¸«à¹‰à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸à¹‡à¸žà¸­"],
    "à¸•à¸¥à¸": ["à¸‚à¸³à¹„à¸£à¸­à¸° à¹à¸šà¹ˆà¸‡à¸¡à¸±à¹ˆà¸‡", "à¹€à¸ªà¹‰à¸™à¸•à¸·à¹‰à¸™à¸™à¸°à¹€à¸£à¸²", "55555555"]
}

# à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸¡à¸­à¸‡
for topic, keys in topics.items():
    brain.append({
        "tags": keys, # à¹€à¸à¹‡à¸šà¹€à¸›à¹‡à¸™ list check à¹„à¸”à¹‰à¹€à¸¥à¸¢
        "answers": answers_pool.get(topic, ["à¸­à¸·à¸¡à¸¡à¸¡"])
    })

# =====================
# EVENTS
# =====================
@bot.event
async def on_ready():
    print(f"Bot ready as {bot.user} | Brain size: {len(brain)} topics")

@bot.event
async def on_message(message):
    if message.author.bot:
        return

    raw = message.content.strip()
    content = clean_text(raw)

    # 1ï¸âƒ£ BAD WORD CHECK (à¸”à¹ˆà¸²à¹à¸¥à¹‰à¸§à¸¥à¸š)
    if any(word in raw for word in bad_words): # à¹€à¸Šà¹‡à¸„à¸ˆà¸²à¸ raw à¸”à¸µà¸à¸§à¹ˆà¸² à¹€à¸œà¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹€à¸§à¹‰à¸™à¸§à¸£à¸£à¸„à¸«à¸¥à¸šà¸„à¸³
        try:
            await message.delete()
        except:
            pass
        await message.channel.send(f"{message.author.mention} à¸žà¸¹à¸”à¸ˆà¸²à¹„à¸¡à¹ˆà¸™à¹ˆà¸²à¸£à¸±à¸à¹€à¸¥à¸¢à¸™à¸°!", delete_after=5)
        return

    # 2ï¸âƒ£ à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸ˆà¸²à¸à¸ªà¸¡à¸­à¸‡ (Logic à¹ƒà¸«à¸¡à¹ˆ)
    best_response = None
    
    # à¸§à¸™à¸¥à¸¹à¸›à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µ keyword à¹ƒà¸™à¸«à¸±à¸§à¸‚à¹‰à¸­à¹„à¸«à¸™à¸šà¹‰à¸²à¸‡
    for item in brain:
        for tag in item["tags"]:
            # à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸² tag à¸™à¸µà¹‰ à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆ user à¸žà¸´à¸¡à¸žà¹Œà¸¡à¸²à¹„à¸«à¸¡
            if tag in content: 
                best_response = random.choice(item["answers"])
                break # à¹€à¸ˆà¸­à¹à¸¥à¹‰à¸§à¸«à¸¢à¸¸à¸”à¸«à¸² tag à¸­à¸·à¹ˆà¸™à¹ƒà¸™à¸«à¸±à¸§à¸‚à¹‰à¸­à¸™à¸µà¹‰
        if best_response:
            break # à¹€à¸ˆà¸­à¸„à¸³à¸•à¸­à¸šà¹à¸¥à¹‰à¸§ à¸«à¸¢à¸¸à¸”à¸«à¸²à¸«à¸±à¸§à¸‚à¹‰à¸­à¸­à¸·à¹ˆà¸™

    if best_response:
        await message.channel.send(f"{best_response} {message.author.mention}")
        return

    # 3ï¸âƒ£ FALLBACK (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸à¸¥à¸²à¸‡à¹†)
    # à¸•à¸±à¸”à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ Regex à¸—à¸µà¹ˆà¸šà¸¥à¹‡à¸­à¸à¸ à¸²à¸©à¸²à¸„à¸™à¸—à¸´à¹‰à¸‡à¹„à¸›à¹à¸¥à¹‰à¸§
    fallback = [
        "à¸­à¸·à¸¡à¸¡ ðŸ¤”",
        "5555 à¸ˆà¸£à¸´à¸´à¸‡à¸”à¸´",
        "à¹€à¸¥à¹ˆà¸²à¸•à¹ˆà¸­à¸ªà¸´",
        "à¸Ÿà¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¸™à¸°",
        "à¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆà¸”à¸µ",
        "à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸•à¹ˆà¸à¹‡à¸£à¸±à¸šà¸Ÿà¸±à¸‡à¸™à¸°",
        "à¸«à¸·à¹‰à¸¡?"
    ]
    
    # à¸ªà¸¸à¹ˆà¸¡à¸•à¸­à¸šà¹€à¸¡à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹€à¸ˆà¸­ Keyword
    # à¹€à¸žà¸´à¹ˆà¸¡à¹‚à¸­à¸à¸²à¸ªà¸•à¸­à¸š 50% à¸žà¸­ (à¸ˆà¸°à¹„à¸”à¹‰à¹„à¸¡à¹ˆ spam à¸—à¸¸à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡) à¸«à¸£à¸·à¸­à¸ˆà¸°à¹€à¸­à¸² 100% à¸à¹‡à¹„à¸”à¹‰à¸•à¸²à¸¡à¹ƒà¸ˆ
    if random.random() > 0.1: 
        await message.channel.send(f"{random.choice(fallback)} {message.author.mention}")

    await bot.process_commands(message)

# ===== RUN =====
server_on()
bot.run(TOKEN)
